# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

GCS Music Streaming Service - AI-powered background music recommendation that analyzes Korean scene descriptions using GPT-3.5 and streams music from Google Cloud Storage using Signed URLs. Supports 19 mood categories mapped to 273 MP3 files across 16 genre folders in a GCS bucket.

## Quick Start

```bash
# Install dependencies
pip install -r requirements.txt

# Setup environment
cp .env.example .env
# Edit .env with: OPENAI_API_KEY, GCS_BUCKET_NAME, GOOGLE_APPLICATION_CREDENTIALS

# Generate file list cache (required on first run or after adding music files)
python generate_file_list.py

# Run service
python music_service_gcs.py
# Server starts at http://localhost:8003

# Test in browser
# Open music_test_client.html or visit http://localhost:8003
```

## Testing

```bash
# Test GCS connection and credentials
python test_gcs_connection.py

# Test all API endpoints
python test_api.py

# Manual API test
curl -X POST http://localhost:8003/api/analyze \
  -H "Content-Type: application/json" \
  -d '{"prompt": "주인공이 숲 속을 탐험한다"}'
```

## Architecture

### Request Flow

```
Client → /api/analyze → GPT-3.5 Analysis → post_process_mood() → select_music_from_mood()
                              ↓                      ↓                        ↓
                        JSON mood analysis    Keyword override    Random file from folders
                                                                           ↓
                                                              GCSMusicManager.generate_signed_url()
                                                                           ↓
                                                                 60-min expiring URL
```

### Core Components

**music_service_gcs.py** - Flask service with three-stage pipeline:
1. `analyze_scene_with_gpt()` - GPT-3.5 with structured JSON output (temperature=0.7)
2. `post_process_mood()` - Keyword-based mood correction to fix GPT misclassifications
3. `select_music_from_mood()` - Random file selection from mood-mapped folders

**gcs_utils.py** - `GCSMusicManager` class handles:
- File list caching in `gcs_music_files.json` (loads from cache, falls back to GCS query)
- Signed URL generation with v4 signing (60-minute expiration)
- Service account authentication via `GOOGLE_APPLICATION_CREDENTIALS`

**MUSIC_LIBRARY** dictionary (music_service_gcs.py:39-116):
- Maps 19 moods → Korean keywords + GCS folder lists
- **NOT** individual files - folders are scanned at runtime
- Used by both GPT system prompt and post-processing logic

### Critical Mood Detection Logic

**GPT misclassification prevention** (music_service_gcs.py:124-160):
- System prompt explicitly instructs: "호기심" → mysterious/curious (NOT horror)
- "긴장" → suspense/tension (NOT horror)
- "두려움/공포" → horror (only when explicitly present)

**Post-processing** (music_service_gcs.py:187-216):
- Keyword override: If prompt contains "호기심" but GPT returns "horror", force "mysterious"
- Prevents false positives from GPT's tendency to over-classify as horror

### File Caching Strategy

**gcs_music_files.json**:
- Generated by `generate_file_list.py` or on-demand by `GCSMusicManager._refresh_file_list()`
- Contains array of blob names: `["Fantasy_mp3/Song.mp3", ...]`
- **Must regenerate** after uploading new files to GCS bucket
- Service loads from cache on startup, reducing GCS API calls

**When to refresh cache**:
```bash
# After uploading new MP3s to GCS bucket
python generate_file_list.py

# Or call gcs_manager.refresh() in code
```

## API Endpoints

**POST /api/analyze** - Main endpoint
- Input: `{"prompt": "씬 설명"}`
- Returns: `{analysis: {...}, music: {mood, filename, file_path, streaming_url}}`
- streaming_url is GCS signed URL (60-min expiration)

**GET /api/moods** - List all moods with keywords and folders

**GET /api/health** - Returns status, version, bucket name, total_files

**GET /** - Serves music_test_client.html

## Configuration

### Environment Variables (.env)

```bash
OPENAI_API_KEY=sk-proj-xxxxx              # Required for GPT-3.5
GCS_BUCKET_NAME=your-bucket-name           # GCS bucket with music files
GOOGLE_APPLICATION_CREDENTIALS=C:\path\to\gcs-service-account-key.json  # Absolute path
PORT=8003
HOST=0.0.0.0
CORS_ORIGINS=*
```

### GCS Bucket Structure

```
bucket-name/
├── Fantasy_mp3/
│   ├── Song1.mp3
│   └── Song2.mp3
├── Horror_mp3/
├── Epic_Dramatic_mp3/
├── Romantic_Sentimental_mp3/
└── ...
```

**16 expected folders**: Comedy_mp3, Electronic_mp3, Epic_Dramatic_mp3, Fantasy_mp3, Horror_mp3, Miscellaneous_Chill_mp3, Miscellaneous_Classical_mp3, Miscellaneous_Country_mp3, Miscellaneous_Jazz_mp3, Miscellaneous_Rock_mp3, romantic, Romantic_Sentimental_mp3, Underscoring_mp3, Uplifting_mp3, World_mp3, Miscellaneous_World_Folk_mp3

### Service Account Permissions

Required GCS roles:
- `Storage Object Viewer` (read files, generate signed URLs)
- `Storage Object Creator` (optional, for upload_file())

## Modifying Mood Mappings

To add/modify moods, edit `MUSIC_LIBRARY` in music_service_gcs.py:

```python
MUSIC_LIBRARY = {
    'new_mood': {
        'keywords': ['한글키워드1', '한글키워드2'],  # For post-processing
        'folders': ['FolderName_mp3']               # GCS folder names
    }
}
```

Then update GPT system prompt (music_service_gcs.py:124) to include new mood in the list.

## Common Issues

**"GCS client creation failed"**
- Check `GOOGLE_APPLICATION_CREDENTIALS` path is absolute and file exists
- Verify service account has Storage Object Viewer role

**"No files found for mood"**
- Run `python generate_file_list.py` to refresh cache
- Verify GCS bucket has MP3 files in expected folders
- Check folder names match MUSIC_LIBRARY mappings exactly

**GPT returns wrong mood**
- Check if keyword is in post-processing logic (music_service_gcs.py:194-199)
- Add keyword to appropriate mood in `mood_keywords` dict
- Update GPT system prompt for better guidance

**Music doesn't play in browser**
- Verify signed URL in response (should contain `storage.googleapis.com`)
- Check browser console for CORS errors
- Ensure GCS bucket allows signed URL access (service account has proper permissions)

## File Management

**Upload file to GCS**:
```python
from gcs_utils import GCSMusicManager
manager = GCSMusicManager(bucket_name='...', credentials_path='...')
manager.upload_file('local/path.mp3', 'Fantasy_mp3/newfile.mp3')
# Cache auto-updates
```

**Delete file from GCS**:
```python
manager.delete_file('Fantasy_mp3/oldfile.mp3')
# Cache auto-updates
```

**Manually refresh cache**:
```python
manager.refresh()  # Fetches all MP3s from GCS, overwrites cache
```
